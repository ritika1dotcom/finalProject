{% extends "base.html" %}

{% block content %}
  <h1 class="text-xl font-bold pb-2">Recommended Songs for {{ user_obj.username }}</h1>

  <div class="flex flex-row justify-between">
      <div class="w-[300px]">
        <h3 class="text-lg font-semibold">Playlist 1</h3>
        <p>Generated by Apriori Algorithm</p>
          {% if recommendations %}
            {% for recommendation in recommendations %}
            <div class="flex flex-col gap-2 pb-5">
              <div class="flex flex-row gap-5 py-2" onclick="playAndMakeTransparent(this, '{{ recommendation.song_details.preview_url }}', '{{ recommendation.song }}', '{{ recommendation.song_details.artist_name }}','{{recommendation.song_details.album_image}}')">
                <img
                  src="{{ recommendation.song_details.album_image }}"
                  alt="{{ recommendation.song }}"
                  width="100"
                  height="50"
                />
                <div>
                  <p class="text-xl font-bold">{{ recommendation.song }}</p>
                  <p class="text-lg font-semibold">Artist Name: {{ recommendation.song_details.artist_name }}</p>
                  <!-- Add a rating component -->
                  <div class="rate">
                    <!-- Display the average rating as a number -->
                    <p>{{ recommendation.rating }}  <span class="star" style="color: #fb9c03;" data-rating="{{ random_song.song_details.rating }}">&#9733;</span></p>
                  </div>
                </div>
              </div>
                <!-- Add a rate button -->
              <button class="rate-button" onclick="showRatingModal('{{ recommendation.song }}')">Rate</button>
            </div>
        
            {% endfor %}
            {% else %}
            {% for random_song in recommended_songs %}
            <div class="flex flex-col gap-2 pb-5">
              <div class="flex flex-row gap-5 py-2" onclick="playAndMakeTransparent(this, '{{ random_song.song_details.preview_url }}', '{{ random_song.song }}', '{{ random_song.song_details.artist_name }}','{{random_song.song_details.album_image}}')">
                <img
                  src="{{ random_song.song_details.album_image }}"
                  alt="{{ random_song.song }}"
                  width="100"
                  height="50"
                />
                <div>
                  <p class="text-xl font-bold">{{ random_song.song }}</p>
                  <p class="text-lg font-semibold">Artist Name: {{ random_song.song_details.artist_name }}</p>
                  <!-- Add a rating component -->
                  <div class="rate">
                    <!-- Display the average rating as a number -->
                    <p>{{ random_song.song_details.rating }}   <span class="star" style="color:#fb9c03;" data-rating="{{ random_song.song_details.rating }}">&#9733;</span></p>
                  </div>
                </div>
              </div>
                <!-- Add a rate button -->
              <button class="rate-button" onclick="showRatingModal('{{ random_song.song }}')">Rate</button>
            </div>
            {% endfor %}
          {% endif %}
      </div>

        <div class="w-[300px]">
          <h3 class="text-lg font-semibold">Playlist 2</h3>
          <!-- Playlist 2 content here -->
          <p>Generated by Matrix Factorization Algorithm</p>
          {% if matrix %}
            {% for recommendation in matrix %}
            <div class="flex flex-col gap-2 pb-5">
              <div class="flex flex-row gap-5 py-2" onclick="playAndMakeTransparent(this, '{{ recommendation.preview_url }}', '{{ recommendation.song_title }}', '{{ recommendation.artist_name }}','{{recommendation.album_image}}')">
                <img
                  src="{{ recommendation.album_image }}"
                  alt="{{ recommendation.song_title }}"
                  width="100"
                  height="50"
                />
                <div>
                  <p class="text-xl font-bold">{{ recommendation.song_title }}</p>
                  <p class="text-lg font-semibold">Artist Name: {{ recommendation.artist_name }}</p>
                  <!-- Add a rating component -->
                  <div class="flex flex-row">
                    <!-- Display the average rating as a number -->
                    <p>{{ recommendation.rating }} <span class="star" style="color:#fb9c03;" data-rating="{{ random_song.song_details.rating }}">&#9733;</span></p>
                    
                </div>
                </div>
              </div>
                  <!-- Add a rate button -->
              <button class="rate-button" onclick="showRatingModal('{{ recommendation.song_title }}')">Rate</button>
            </div>
            
            {% endfor %}
            {% else %}
              {% for random_song in random_recommendation_matrix %}
              <div class="flex flex-col gap-2 pb-5">
                <div class="flex flex-row gap-5 py-2" onclick="playAndMakeTransparent(this, '{{ random_song.song_details.preview_url }}', '{{ random_song.song }}', '{{ random_song.song_details.artist_name }}','{{random_song.song_details.album_image}}')">
                  <img
                    src="{{ random_song.song_details.album_image }}"
                    alt="{{ random_song.song }}"
                    width="100"
                    height="50"
                  />
                  <div>
                    <p class="text-xl font-bold">{{ random_song.song }}</p>
                    <p class="text-lg font-semibold">Artist Name: {{ random_song.song_details.artist_name }}</p>
                    <!-- Add a rating component -->
                    <div class="rate">
                      <!-- Display the average rating as a number -->
                      <p>{{ random_song.song_details.rating }}  <span class="star" style="color:#fb9c03;" data-rating="{{ random_song.song_details.rating }}">&#9733;</span></p>
                    </div>
                  </div>
                </div>
                <!-- Add a rate button -->
                <button class="rate-button" onclick="showRatingModal('{{ random_song.song }}')">Rate</button>
              </div>
              {% endfor %}
          {% endif %}
        </div>
    </div>
  
  
  <!--  -->
  <!--  -->
  <!-- Modal -->
  <div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="feedbackModalLabel">Which playlist did you like best?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="feedbackForm">
                    <!-- Algorithm Selection -->
                    <div class="mb-4">
                        <label for="algorithm" class="block text-gray-300">Select Playlist</label>
                        <select id="algorithm" name="algorithm" class="border rounded w-full py-2 px-3 text-black bg-gray-300 focus:outline-none focus:border-blue-500" required>
                            <option value="Apriori">Playlist 1</option>
                            <option value="Matrix">Playlist 2</option>
                        </select>
                    </div>

                    <!-- Submit Button -->
                    <button type="button" onclick="submitFeedback()">Submit</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Rating -->
<div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ratingModalLabel">Rate Song</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="ratingForm" method="post" action="{% url 'update_song_rating'  request.user.username %}">
          {% csrf_token %}
          <input type="hidden" id="songName" name="songName" value="">
          <div class="mb-3">
            <label for="rating" class="form-label">Rating:</label>
            <div class="star-rating" id="stars">
              <span class="star" data-rating="1">&#9733;</span>
              <span class="star" data-rating="2">&#9733;</span>
              <span class="star" data-rating="3">&#9733;</span>
              <span class="star" data-rating="4">&#9733;</span>
              <span class="star" data-rating="5">&#9733;</span>
              <input type="hidden" name="rating" id="rating" value="0">
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Submit</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const stars = document.querySelectorAll('.star');
    stars.forEach(star => {
        star.addEventListener('click', function () {
            const rating = this.getAttribute('data-rating');
            document.getElementById('rating').value = rating;
            stars.forEach(s => {
                if (parseInt(s.getAttribute('data-rating')) <= rating) {
                    s.classList.add('rated');
                } else {
                    s.classList.remove('rated');
                }
            });
        });
    });
});
  let sweetAlertDisplayed = false; // Flag to track whether SweetAlert has been displayed

  // Add these lines to include userAgeGroup and userFavoriteGenre
  var userAgeGroup = "Unknown";
  var userFavoriteGenre = "Unknown";
  const username = window.location.pathname.split('/')[2];

  // Make AJAX request to get user preferences
  $.ajax({
    type: 'GET',
    url: '/spotify/' + username + '/preference/',  // Replace <your-username> with the actual username
    dataType: 'json',
    success: function (data) {
      if ('age_group' in data && 'favorite_music_genre' in data) {
        userAgeGroup = data.age_group;
        userFavoriteGenre = data.favorite_music_genre;
      }
    },
    error: function (error) {
      console.error('Error getting user preferences:', error);
    }
  });
  function showFeedbackModal() {
    $('#feedbackModal').modal('show');
  }

  // Call showFeedbackModal after 30 seconds
  setTimeout(showFeedbackModal, 60000);

  
  function submitFeedback() {
    const algorithm = document.getElementById('algorithm').value;

    if (algorithm) {
        const playlistName = algorithm === 'Apriori' ? 'Playlist 1' : 'Playlist 2';
        const csrftoken = getCookie('csrftoken');

        // Include both algorithm and user_has_preference values in data
        const data = {
            'algorithm': algorithm,
            'age_group': userAgeGroup,
            'favorite_genre': userFavoriteGenre
        };

        $.ajax({
            type: 'POST',
            url: '/spotify/' + username + '/feedback/',
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            data: JSON.stringify({ 'data': data }),
            headers: { 'X-CSRFToken': csrftoken },
            success: function (data) {
                sweetAlertDisplayed = true;
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: `Thank you for your feedback! You liked the ${playlistName}.`,
                })
              //  Hide feedback modal
                $('#feedbackModal').modal('hide');
            },
            error: function (error) {
                console.error('Error submitting feedback:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to submit feedback. Please try again.',
                });
            }
        });
        console.log("data",data)
    } else {
        Swal.fire({
            icon: 'error',
            title: 'Validation Error',
            text: 'Please select an algorithm before submitting.',
        });
    }
  }

    function showRatingModal(songName) {
      $('#songName').val(songName);
      $('#ratingModal').modal('show');
  }
  // Function to get the CSRF token from the cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

</script>


{% endblock %}
